when:
  - event: [push, manual]
    branch: [main]
  - event: [pull_request]
    # Only run when PR targets main branch
    evaluate: 'CI_COMMIT_TARGET_BRANCH == "main"'
    # Build the source branch (not main)
    branch:
      exclude: [main]

variables:
  - &docker_repo 'josaorg/contributions-web'
  - &slack_channel 'builds'
  # Docker build arguments template
  - &build_args_template
    - CI_COMMIT_SHA=${CI_COMMIT_SHA}
    - CI_BUILD_NUMBER=${CI_BUILD_NUMBER}
    - CI_BUILD_LINK=${CI_BUILD_LINK}
    - CI_COMMIT_LINK=${CI_COMMIT_LINK}
    - CI_REPO_LINK=${CI_REPO_LINK}
    - CI_BUILD_FINISHED=${CI_BUILD_FINISHED}
    - CONTRIBUTIONS_API_URL=http://contributions.api.svc.cluster.local:8080
    - MATOMO_SITE_ID=10
    - TARGET_ENV=production
  # Success message template
  - &success_message >
    âœ… *SUCCESS* - Stable Build #{{ build.number }}

    ğŸ“ *Repository:* {{ repo.name }}
    ğŸŒ¿ *Branch:* {{ build.branch }}
    ğŸ“ *Commit:* {{ truncate build.commit 8 }}
    ğŸ‘¤ *Author:* {{ build.author }}

    ğŸ”— *Links:*
    â€¢ <{{ build.link }}|View Build>
  # Failure message template
  - &failure_message >
    âŒ *FAILED* - Stable Build #{{ build.number }}

    ğŸ“ *Repository:* {{ repo.name }}
    ğŸŒ¿ *Branch:* {{ build.branch }}
    ğŸ“ *Commit:* {{ truncate build.commit 8 }}
    ğŸ‘¤ *Author:* {{ build.author }}

    ğŸ”— *Links:*
    â€¢ <{{ build.link }}|View Build>

steps:
  # Security check - scan for secrets/credentials
  - name: check-for-leaks
    image: zricethezav/gitleaks:v8.18.4
    commands:
      - gitleaks detect --source . --verbose

  # Build stable image (main branch only)
  - name: build-stable-image
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: *docker_repo
      dockerfile: ./Dockerfile
      tags:
        - ${CI_COMMIT_SHA:-latest}
        - stable
      username:
        from_secret: DOCKER_HUB_USERNAME
      password:
        from_secret: DOCKER_HUB_PASSWORD
      build_args: *build_args_template
    depends_on:
      - check-for-leaks

  # Slack notification for stable build success
  - name: notify-slack-stable-success
    image: plugins/slack
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: *slack_channel
      template: *success_message
    when:
      - status: success
    depends_on:
      - check-for-leaks
      - build-stable-image

  # Slack notification for stable build failure
  - name: notify-slack-stable-failure
    image: plugins/slack
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: *slack_channel
      template: *failure_message
    when:
      - status: failure
    depends_on:
      - check-for-leaks
      - build-stable-image
